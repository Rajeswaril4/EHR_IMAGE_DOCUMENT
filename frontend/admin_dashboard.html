<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- ===== Top Bar ===== -->
<header class="bg-blue-900 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-semibold">Admin Dashboard</h1>

    <div>
        <span id="user-email" class="mr-4 font-medium"></span>
        <button onclick="logout()" class="bg-red-600 px-4 py-1 rounded">
            Logout
        </button>
    </div>
</header>

<!-- ===== Main ===== -->
<main class="p-6">

    <h2 class="text-lg font-semibold mb-4">Registered Users</h2>

    <div class="overflow-x-auto bg-white shadow rounded">
        <table class="min-w-full border">
            <thead class="bg-gray-200">
                <tr>
                    <th class="p-2 border">Email</th>
                    <th class="p-2 border">Role</th>
                    <th class="p-2 border">Actions</th>
                </tr>
            </thead>
            <tbody id="users-table">
                <!-- populated by JS -->
            </tbody>
        </table>
    </div>

</main>

<!-- ===== Scripts ===== -->
<script>
/* ================= AUTH ================= */

function getToken() {
    return localStorage.getItem('auth_token');
}

function logout() {
    localStorage.removeItem('auth_token');
    window.location.href = "/login.html";
}

/* ================= FETCH WRAPPER ================= */

async function authenticatedFetch(url, options = {}) {
    const token = getToken();
    if (!token) {
        logout();
        return;
    }

    options.headers = {
        ...(options.headers || {}),
        "Authorization": `Bearer ${token}`
    };

    return fetch(url, options);
}

/* ================= LOAD CURRENT ADMIN ================= */

async function loadCurrentUser() {
    const res = await authenticatedFetch("/api/whoami");
    if (!res || !res.ok) {
        logout();
        return;
    }
    const data = await res.json();
    document.getElementById("user-email").textContent = data.email;
}

/* ================= LOAD USERS ================= */

async function loadUsers() {
    const res = await authenticatedFetch("/api/admin/list_users");
    if (!res || !res.ok) {
        alert("Failed to load users");
        return;
    }

    const users = await res.json();
    const tbody = document.getElementById("users-table");
    tbody.innerHTML = "";

    users.forEach(user => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td class="p-2 border">${user.email}</td>
            <td class="p-2 border">${user.role}</td>
            <td class="p-2 border space-x-2">
                <button
                    onclick="setRole('${user.email}','admin')"
                    class="bg-green-600 text-white px-2 py-1 rounded">
                    Make Admin
                </button>

                <button
                    onclick="setRole('${user.email}','user')"
                    class="bg-yellow-600 text-white px-2 py-1 rounded">
                    Make User
                </button>

                <button
                    onclick="deleteUser('${user.email}')"
                    class="bg-red-600 text-white px-2 py-1 rounded">
                    Delete
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* ================= ROLE UPDATE ================= */

async function setRole(email, role) {
    const currentUser = document.getElementById('user-email').textContent;

    if (email === currentUser && role === 'user') {
        if (!confirm("You are about to remove your own admin rights. Continue?")) {
            return;
        }
    }

    try {
        const res = await authenticatedFetch("/api/admin/set_role", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, role })
        });

        if (!res || !res.ok) {
            const err = await res.json();
            alert(err.error || "Role update failed");
            return;
        }

        alert(`Updated ${email} to ${role}`);
        loadUsers();

    } catch (e) {
        alert("Network error");
    }
}

/* ================= DELETE USER ================= */

async function deleteUser(email) {
    const currentUser = document.getElementById('user-email').textContent;

    if (email === currentUser) {
        alert("You cannot delete yourself");
        return;
    }

    const confirmation = prompt(
        `WARNING: Permanently delete ALL data for ${email}\n\nType the email to confirm`
    );

    if (confirmation !== email) {
        alert("Email mismatch. Cancelled.");
        return;
    }

    try {
        const res = await authenticatedFetch(
            `/api/admin/delete_user/${encodeURIComponent(email)}`,
            { method: "DELETE" }
        );

        if (!res || !res.ok) {
            const err = await res.json();
            alert(err.error || "Deletion failed");
            return;
        }

        alert(`Deleted ${email}`);
        loadUsers();

    } catch (e) {
        alert("Network error");
    }
}

/* ================= INIT ================= */

loadCurrentUser();
loadUsers();
</script>

</body>
</html>
